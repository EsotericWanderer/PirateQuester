@page "/"
@using DFKContracts.HeroCore;
@using DFKContracts.QuestCore.ContractDefinition;
@using Nethereum.RPC.Eth.DTOs;
@using Nethereum.Web3;
@using PirateQuester.DFK.Contracts;
@using global::DFK;
@using global::Utils;
@inject AccountManager accounts
@inject NavigationManager NM
@inject DialogService DS
@inject GlobalState GS
@inject TransactionManager Transact
@inject IJSInProcessRuntime JS

<PageTitle>PQ - Home</PageTitle>
<RadzenText class="text-center mt-2" TextStyle="TextStyle.H5">List Account Heroes</RadzenText>
<RadzenTextArea @bind-Value=@ownerInput
	Placeholder="Additional addresses"
	Change="@LoadHeroes"
	Class="w-100 my-3 py-3" />
@if(accounts.Accounts.Count > 0)
{
	<RadzenDropDown AllowClear="true"
		AllowFiltering="true"
		FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
		@bind-Value=@GS.LoadedOwnersHomescreen
		Multiple="true"
		Placeholder="Select..."
		Data="@accounts.Accounts.Select(acc => acc.Account.Address).ToList()"
		TextProperty=""
		ValueProperty=""
		Chips="true"
		Change="@LoadHeroes"
		Class="w-100 my-3 py-3" />
	<RadzenCard class="my-2">
		<RadzenTextBox @bind-Value=@Attempts>
		</RadzenTextBox>
		<RadzenButton ButtonStyle="StartQuestStyle" Disabled="StartQuestButtonDisabled" Click="@StartFishing">
			Start Fishing!
		</RadzenButton>
		<RadzenButton ButtonStyle="StartQuestStyle" Disabled="StartQuestButtonDisabled" Click="@CompleteQuest">
			Complete Quests
		</RadzenButton>
	</RadzenCard>
}
@if(Loading)
{
	<RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" ProgressBarStyle="ProgressBarStyle.Secondary" />
}
<RadzenDataGrid
	Data="@GS.LoadedHeroesHomeScreen"
	TItem="Hero"
	SelectionMode="DataGridSelectionMode.Multiple" 
	@ref="heroes"
	@bind-Value=@SelectedHeroes
	RowClick="@UpdateSelection"
	AllowRowSelectOnRowClick="true"
	AllowPaging="true"
	AllowSorting="true"
	AllowColumnReorder="true"
	AllowColumnResize="true"
	AllowFiltering="true"
	ShowPagingSummary="true"
	ColumnWidth="100px"
	PagerHorizontalAlign="HorizontalAlign.Center"
	PageSize="15"
	Style="max-height:700px;"
	PagingSummaryFormat="@pagingSummaryFormat">
	<Columns>
		<RadzenDataGridColumn TItem="Hero" Property="owner" Title="Owner" Width="150px">
			<Template Context="data">
				@if(data.owner is not null)
				{
					@data.owner.Name
				}
			</Template>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn TItem="Hero" Property="owner" Title="Owner Address" Width="150px">
			<Template Context="data">
				@if (data.owner is not null)
				{
					@data.owner.Id
				}
			</Template>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn TItem="Hero" Property="id" Title="Id">
			<Template Context="data">
				@(ulong.Parse(data.id) > 1000000000000 ? $"CV-{ulong.Parse(data.id) - 1000000000000}" : ulong.Parse(data.id))
			</Template>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn TItem="Hero" Property="currentQuest" Title="Current Quest" Width="200px">
			<Template Context="data">
				@data.GetCurrentQuestName()
			</Template>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn TItem="Hero" Property="stamina" Title="Stamina">
			<Template Context="data">
				@data.StaminaCurrent(JS)/@data.stamina
			</Template>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn TItem="Hero" Property="salePrice" Title="Cost">
				<Template Context="data">
					@if(data.salePrice is not null)
					{
							@data.SalePrice(2)
					}
					else{
						<span>
							Not for Sale
						</span>
					}
				</Template>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn TItem="Hero" Property="mainClass" Title="Class" />
		<RadzenDataGridColumn TItem="Hero" Property="subClass" Title="Subclass" />
		<RadzenDataGridColumn TItem="Hero" Property="GetRarity" Title="Rarity">
			<Template Context="data">
				@data.GetRarity()
			</Template>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn TItem="Hero" Property="FullName" Title="Name" Width="200px">
			<Template Context="data">
				@data.FullName()
			</Template>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn TItem="Hero" Property="level" Title="Level"/>
		<RadzenDataGridColumn TItem="Hero" Property="generation" Title="Generation"/>
		<RadzenDataGridColumn TItem="Hero" Property="statBoost1" Title="Statboost 1" />
		<RadzenDataGridColumn TItem="Hero" Property="statBoost2" Title="Statboost 2" />
		<RadzenDataGridColumn TItem="Hero" Property="profession" Title="Profession" />
		<RadzenDataGridColumn TItem="Hero" Property="strength" Title="Strength" />
		<RadzenDataGridColumn TItem="Hero" Property="dexterity" Title="Dexterity" />
		<RadzenDataGridColumn TItem="Hero" Property="agility" Title="Agility" />
		<RadzenDataGridColumn TItem="Hero" Property="vitality" Title="Vitality" />
		<RadzenDataGridColumn TItem="Hero" Property="endurance" Title="Endurance" />
		<RadzenDataGridColumn TItem="Hero" Property="intelligence" Title="Intelligence" />
		<RadzenDataGridColumn TItem="Hero" Property="wisdom" Title="Wisdom" />
		<RadzenDataGridColumn TItem="Hero" Property="luck" Title="Luck" />
	</Columns>
</RadzenDataGrid>

@code{
	string pagingSummaryFormat = "Displaying page {0} of {1} (total {2} records)";
	bool Loading = false;
	string ownerInput = "";
	IList<Hero> SelectedHeroes;
	RadzenDataGrid<Hero> heroes;
	ButtonStyle StartQuestStyle = ButtonStyle.Secondary;
	bool StartQuestButtonDisabled = true;
	string Attempts = "1";

	private async Task CompleteQuest()
	{
		StringBuilder output = new();
		DFKAccount acc = accounts.Accounts.FirstOrDefault();
		try
		{
			int skip = 0;
			while (skip <= SelectedHeroes.Count)
			{
				List<Hero> heroes = SelectedHeroes.ToList().Skip(skip).Take(6).ToList();
				var transactionReceipt= await Transact.CompleteQuest(accounts.Accounts.FirstOrDefault(), heroes.ToList());
				Console.WriteLine($"{transactionReceipt.Status}: {string.Join(", ", transactionReceipt.Logs)}");
				output.AppendLine($"Completed fishing for: {string.Join(", ", heroes)}");
			}
		}
		catch (Exception e)
		{
			Console.WriteLine($"{e.Source} - {e.Message} - {e.InnerException?.Message}");
			output.AppendLine(e.Message);
		}
		DS.Open("Transaction", txn =>
		@<div>
			<div>
				@output
			</div>
		</div>
	,
		new DialogOptions() { Width = "700px", Height = "512px", Resizable = true, Draggable = true, CloseDialogOnEsc = true, ShowClose = true });
	}

	private async Task StartFishing()
	{
		StringBuilder output = new();
		DFKAccount acc = accounts.Accounts.FirstOrDefault();
		try
		{
			int skip = 0;
			while (skip <= SelectedHeroes.Count)
			{
				List<Hero> heroes = SelectedHeroes.ToList().Skip(skip).Take(6).ToList();
				var transactionReceipt = await Transact.StartQuest(acc, heroes, QuestType.FISHING, int.Parse(Attempts));
				Console.WriteLine($"{transactionReceipt.Status}: {string.Join(", ", transactionReceipt.Logs)}");
				output.AppendLine($"Started fishing for: {string.Join(", ", heroes)}");
			}
		}
		catch(Exception e)
		{
			Console.WriteLine($"{e.Source} - {e.Message} - {e.InnerException?.Message}");
			output.AppendLine(e.Message);
		}
		DS.Open("Transaction", txn =>
			@<div>
				<div>
					@output
				</div>
		</div>,
		new DialogOptions() { Width = "700px", Height = "512px", Resizable = true, Draggable = true, CloseDialogOnEsc = true, ShowClose = true });
	}

	private void UpdateSelection()
	{
		if(heroes.Count > 0)
		{
			StartQuestButtonDisabled = false;
			StartQuestStyle = ButtonStyle.Success;
		}
		else
		{
			StartQuestButtonDisabled = true;
			StartQuestStyle = ButtonStyle.Warning;
		}
	}
	protected override void OnInitialized()
	{
		if (GS.LoadedHeroesHomeScreen.Count == 0)
		{
			//GS.LoadedHeroesHomeScreen = accounts.Accounts.SelectMany(acc => acc.Heroes).ToList();
			//GS.LoadedOwnersHomescreen = accounts.Accounts.Select(acc => acc.Account.Address).ToList();
		}
	}

	private async Task LoadHeroes()
	{
		if (GS.LoadedOwnersHomescreen is null)
		{
			return;
		}
		List<string> ownerArg = GS.LoadedOwnersHomescreen;
		if (ownerInput != "")
		{
			string[] inputOwners = ownerInput.Split(new string[] { ",", "\r\n", "\n", "\r" }, StringSplitOptions.TrimEntries);
			foreach (string o in inputOwners)
			{
				if (o.Length == 42 && o.StartsWith("0x"))
				{
					ownerArg.Add(o);
				}
			}
		}
		if (ownerArg.Count > 0)
		{
			Loading = true;
			Dictionary<HeroesArgument, string> args = new();
			args.Add(HeroesArgument.owner_in, $@"[""{string.Join(@""",""", ownerArg)}""]");
			string request = API.HeroesRequestBuilder(args);
			GS.LoadedHeroesHomeScreen = (await API.GetHeroes(request)).ToList();
			Console.WriteLine(GS.LoadedHeroesHomeScreen);
			Loading = false;
		}
	}

}